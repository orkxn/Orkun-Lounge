<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lounge Chat | Orkun Lounge</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0; padding: 0; box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background-color: #050505;
            background-image: radial-gradient(circle at center, #2a003b 0%, #000000 70%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #ffffff;
            padding: 10px;
        }

        /* --- ANA KONTEYNER (EKRANI KAPLAYAN YAPI) --- */
        .chat-wrapper {
            background-color: rgba(10, 10, 10, 0.95);
            width: 95%; /* EkranÄ±n %95'ini kaplar */
            max-width: 1400px;
            height: 90vh; /* Ekran yÃ¼ksekliÄŸinin %90'Ä± */
            display: flex;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 0 50px rgba(205, 0, 255, 0.2);
            border: 1px solid #2a003b;
        }

        /* --- SOL PANEL: ONLINE LÄ°STESÄ° --- */
        .online-sidebar {
            width: 250px;
            background: rgba(20, 20, 20, 0.8);
            border-right: 1px solid rgba(205, 0, 255, 0.1);
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        .online-sidebar h3 {
            font-size: 16px;
            color: #cd00ff;
            margin-bottom: 20px;
            letter-spacing: 1px;
        }

        .user-list {
            list-style: none;
            overflow-y: auto;
        }

        .user-item {
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .online-dot {
            width: 8px; height: 8px;
            background: #00ff44;
            border-radius: 50%;
            box-shadow: 0 0 10px #00ff44;
        }

        /* --- SAÄ PANEL: CHAT ALANI --- */
        .main-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 30px;
            background: transparent;
        }

        .chat-header {
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* --- MESAJLAR --- */
        #messages {
            flex: 1;
            overflow-y: auto;
            padding-right: 15px;
            margin-bottom: 25px;
        }

        .message-item {
            background: rgba(255, 255, 255, 0.03);
            margin-bottom: 15px;
            padding: 12px 18px;
            border-radius: 15px;
            max-width: 80%;
            border-left: 3px solid #cd00ff;
            animation: slideIn 0.3s ease-out;
        }

        /* Mesaj Yazma AlanÄ± KonteynÄ±rÄ± */
        .input-area {
            display: flex;
            align-items: center; /* Buton ve yazÄ±yÄ± hizalar */
            gap: 10px;
            background: rgba(255, 255, 255, 0.05);
            padding: 10px 20px;
            border-radius: 30px;
            border: 1px solid rgba(205, 0, 255, 0.3);
        }

        /* Garip gÃ¶rÃ¼nen textarea'yÄ± ÅŸÄ±klaÅŸtÄ±ralÄ±m */
        #messageInput {
            flex: 1;
            background: transparent;
            border: none;
            color: white;
            font-size: 15px;
            outline: none;
            resize: none; /* KÃ¶ÅŸedeki Ã§ekme iÅŸaretini kaldÄ±rÄ±r */
            padding: 5px 0;
            max-height: 80px;
            overflow-y: auto; /* Ã‡ok uzarsa scroll Ã§Ä±ksÄ±n */
        }

        /* Scrollbar'Ä± gizleyelim veya ÅŸÄ±klaÅŸtÄ±ralÄ±m */
        #messageInput::-webkit-scrollbar {
            width: 0px;
        }

        .send-btn {
            background: #cd00ff;
            color: #000;
            border: none;
            padding: 0 30px;
            border-radius: 50px;
            font-weight: 700;
            cursor: pointer;
            transition: 0.3s;
        }

        .send-btn:hover {
            box-shadow: 0 0 20px rgba(205, 0, 255, 0.6);
            transform: scale(1.05);
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* VOICE CONTROLS PANELÄ° (BOÅLUK EKLEME) */
        .voice-controls {
            width: 220px;
            padding: 20px;
            background: rgba(15, 15, 15, 0.5); /* Sidebar'dan biraz daha farklÄ± bir ton */
            border-right: 1px solid rgba(205, 0, 255, 0.1);
            margin-left: 20px; /* ONLINE USERS kÄ±smÄ±ndan saÄŸa iten boÅŸluk */
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .voice-controls h3 {
            font-size: 16px;
            color: #cd00ff;
            letter-spacing: 1px;
        }

        
        .voice-badge {
            color: #00ff44;     
            font-size: 12px;    
            font-weight: 700;    
            margin-left: 8px;    
            letter-spacing: 0.5px;
            vertical-align: middle;
            
        }

        /* --- DASHBOARD GERÄ° DÃ–N BUTONU --- */
        .back-btn {
            text-decoration: none;      /* Alt Ã§izkiyi kaldÄ±r */
            color: #cd00ff;            /* Mor yazÄ± */
            border: 1px solid #cd00ff; /* Mor Ã§erÃ§eve */
            padding: 8px 15px;
            border-radius: 20px;       /* Yuvarlak kÃ¶ÅŸeler */
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 20px;       /* AltÄ±ndaki liste ile boÅŸluk bÄ±rak */
            text-align: center;
            transition: all 0.3s ease;
            display: flex;             /* Ok ve yazÄ±yÄ± hizalamak iÃ§in */
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .back-btn span {
            font-size: 18px;           /* Ok iÅŸaretini biraz bÃ¼yÃ¼t */
            line-height: 1;
        }

        .back-btn:hover {
            background: #cd00ff;       /* Ãœzerine gelince mor dolgu */
            color: #000;               /* YazÄ± siyah olsun */
            box-shadow: 0 0 15px rgba(205, 0, 255, 0.5); /* Neon parlama */
            transform: translateX(-3px); /* Hafif sola kayma efekti */
        }


    </style>
</head>
<body>

    <div class="chat-wrapper">
        <div class="online-sidebar">
            <a href="/dashboard" class="back-btn">
                <span>&#8592;</span> Dashboard
            </a>
            <h3>Online Users</h3>
            <ul class="user-list" id="userList">
                <li class="user-item"><span class="online-dot"></span> ... (You)</li>
            </ul>
        </div>

    <div class="voice-controls">
    <h3>Voice Channel</h3>
    <button id="voiceBtn" class="send-btn" style="width: 100%;">JOIN VOICE</button>
    
    <div id="voiceActions" style="display: none; margin-top: 15px; display: flex; justify-content: space-around; background: #111; padding: 10px; border-radius: 15px; border: 1px solid #2a003b;">
        <button id="muteBtn" title="Mute/Unmute" style="background:none; border:none; cursor:pointer; color:#cd00ff; font-size:18px;">ğŸ¤</button>
        <button id="deafenBtn" title="Deafen/Undeafen" style="background:none; border:none; cursor:pointer; color:#cd00ff; font-size:18px;">ğŸ§</button>
        <button id="leaveBtn" title="Leave Voice" style="background:none; border:none; cursor:pointer; color:#ff0044; font-size:18px;">âŒ</button>
    </div>
    </div>    

        <div class="main-chat">
            <div class="chat-header">
                <h2>Lounge <span>Chat</span></h2>
                <span id="status" style="color: #00ff44; font-size: 12px;">â— Connected</span>
            </div>

            <div id="messages"></div>

            <div class="input-area">
                <textarea id="messageInput" placeholder="Write something..." autocomplete="off" rows="1"></textarea>
                <button class="send-btn" onclick="sendMessage()">SEND</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script>
        // --- 1. TANIMLAMALAR (EN BAÅTA OLMALI) ---
        const socket = io();
        
        
        const peer = new Peer(); 
        
        let currentUsername = "";
        let myStream;
        let isMuted = false;
        let isDeafened = false;
        const peers = {}; 

        // --- 2. KÄ°MLÄ°K TESPÄ°TÄ° ---
        fetch('/api/userinfo')
            .then(res => res.json())
            .then(data => {
                currentUsername = data.username;
                socket.emit('user_joined', currentUsername);
            })
            .catch(err => console.error("User info couldn.'t gathered.", err));

        // --- 3. PEERJS BAÄLANTISI ---
        peer.on('open', (id) => {
            console.log('âœ… PeerJS Connected. ID:', id);
        });
        
        peer.on('error', (err) => {
            console.error('âŒ PeerJS Error:', err);
        });

        // --- 4. MESAJLAÅMA (TEXT CHAT) ---
        function sendMessage() {
            const input = document.getElementById('messageInput');
            if (input.value.trim() && currentUsername) {
                socket.emit('chat_message', { user: currentUsername, text: input.value });
                input.value = '';
            }
        }

        document.getElementById('messageInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        socket.on('new_message', (data) => {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message-item';
            const formattedText = data.text.replace(/\n/g, '<br>');
            msgDiv.innerHTML = `<strong>${data.user}</strong><br>${formattedText}`;
            const container = document.getElementById('messages');
            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;
        });

        socket.on('update_user_list', (users) => {
            const userList = document.getElementById('userList');
            
            // 1. TEMÄ°ZLÄ°K: Ã–nce listeyi tamamen boÅŸalt (KlonlanmayÄ± Ã¶nler)
            userList.innerHTML = ''; 
            
            users.forEach(user => {
                const alreadyExists = userList.querySelector(`[data-username="${user}"]`);
                if (alreadyExists) return;

                // 3. ELEMENT OLUÅTURMA
                const li = document.createElement('li');
                li.className = 'user-item';
                
                li.setAttribute('data-username', user); 

                const isMe = user === currentUsername ? ' <span style="opacity:0.5;">(You)</span>' : '';
                
                // 6. Ä°Ã‡ERÄ°ÄÄ° DOLDUR
                li.innerHTML = `<span class="online-dot"></span> ${user}${isMe}`;
                
                // 7. LÄ°STEYE EKLE
                userList.appendChild(li);
            });
        });

       
        socket.on('user-voice-status', (data) => {
            console.log("Voice state came from server:", data); 

            
            let userElement = document.querySelector(`[data-username="${data.username}"]`);

            
            if (!userElement) {
                console.log("Couldn't find with lowercase, trying uppercase.");
                const upperName = data.username.toLocaleUpperCase('en-US');
                userElement = document.querySelector(`[data-username="${upperName}"]`);
            }

            
            if (!userElement) {
                const trUpper = data.username.toUpperCase();
                userElement = document.querySelector(`[data-username="${trUpper}"]`);
            }

            if (userElement) {
                console.log("âœ… User found, adding badge.");
                
                // Eski badge'i temizle
                const oldBadge = userElement.querySelector('.voice-badge');
                if (oldBadge) oldBadge.remove();

                // Sesteyse ekle
                if (data.inVoice) {
                    const badge = document.createElement('span');
                    badge.className = 'voice-badge';
                    badge.innerText = ' IN VOICE';
                    userElement.appendChild(badge);
                }
            } else {
                console.error("âŒ ERROR: User couldn't find! Check data-username on HTML");
            }
        });


        
        // A) Join Voice Butonu (GÃœNCELLENMÄ°Å VE FÄ°NAL HALÄ°)
        const voiceBtn = document.getElementById('voiceBtn');

        if (voiceBtn) {
            voiceBtn.addEventListener('click', async () => {
                // PeerJS hazÄ±r deÄŸilse uyarÄ± ver
                if (!peer || !peer.id) {
                    alert("Connection preparing. Please wait...");
                    return;
                }

                try {
                    // 1. Mikrofon izni iste
                    myStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    
                    // 2. GÃ¶rsel DeÄŸiÅŸiklikler (Butonu 'ON VOICE' yap)
                    voiceBtn.innerText = "ON VOICE";
                    voiceBtn.style.color = "#00ff44";       // YeÅŸil yazÄ±
                    voiceBtn.style.borderColor = "#00ff44"; // YeÅŸil Ã§erÃ§eve
                    voiceBtn.style.boxShadow = "0 0 15px rgba(0, 255, 68, 0.4)"; // Neon parlama
                    voiceBtn.disabled = true;               // TÄ±klamayÄ± engelle
                    voiceBtn.style.cursor = "default";

                    // 3. Kontrol panelini (Mute/Leave butonlarÄ±nÄ±) aÃ§
                    const actionsDiv = document.getElementById('voiceActions');
                    if(actionsDiv) actionsDiv.style.display = 'flex';

                    // 4. Sunucuya bildir (DiÄŸerleri gÃ¶rsÃ¼n diye)
                    socket.emit('join-voice', { 
                        peerId: peer.id, 
                        username: currentUsername 
                    });

                    
                    // Sunucuyu beklemeden, kendi isminin yanÄ±na yazÄ±yÄ± yapÄ±ÅŸtÄ±rÄ±yoruz.
                    const myUserElement = document.querySelector(`[data-username="${currentUsername}"]`);
                    
                    if (myUserElement) {
                        // Varsa eskisi silinir (bug olmasÄ±n diye)
                        const oldBadge = myUserElement.querySelector('.voice-badge');
                        if (oldBadge) oldBadge.remove();

                        // Yeni badge oluÅŸturulur
                        const badge = document.createElement('span');
                        badge.className = 'voice-badge';
                        badge.innerText = ' IN VOICE';
                        
                        
                        myUserElement.appendChild(badge);
                    }
                    

                    console.log("Entered to voice chat, sent to server and written to user's screen.");

                } catch (err) {
                    console.error("Mic error:", err);
                    alert("Couldn't access to mic! Please check browser permissions.");
                }
            });
        }

        // B) Biri Bizi Ararsa (Cevaplama)
        peer.on('call', (call) => {
            call.answer(myStream);
            const audio = document.createElement('audio');
            
            call.on('stream', (userStream) => {
                addAudioStream(audio, userStream);
                if (isDeafened) audio.muted = true;
            });
            peers[call.peer] = call;
        });

        // C) Yeni Biri Gelirse
        socket.on('user-joined-voice', (data) => {
            if (data.peerId === peer.id) return; 

            const call = peer.call(data.peerId, myStream);
            const audio = document.createElement('audio');
            
            call.on('stream', (userStream) => {
                addAudioStream(audio, userStream);
                if (isDeafened) audio.muted = true;
            });
            peers[data.peerId] = call;
        });

        

        // Mute (Mikrofonu Kapat)
        document.getElementById('muteBtn').addEventListener('click', () => {
            if (!myStream) return;
            isMuted = !isMuted;
            myStream.getAudioTracks()[0].enabled = !isMuted;
            
            const btn = document.getElementById('muteBtn');
            btn.innerText = isMuted ? "ğŸ”‡" : "ğŸ¤";
            btn.style.color = isMuted ? "#ff0044" : "#cd00ff";
        });

        // Deafen (Sesi Kapat)
        document.getElementById('deafenBtn').addEventListener('click', () => {
            isDeafened = !isDeafened;
            document.querySelectorAll('#remote-audios audio').forEach(audio => audio.muted = isDeafened);
            
            const btn = document.getElementById('deafenBtn');
            btn.innerText = isDeafened ? "ğŸš«" : "ğŸ§";
            btn.style.color = isDeafened ? "#ff0044" : "#cd00ff";
        });

        // Leave (AyrÄ±l) Butonu
        document.getElementById('leaveBtn').addEventListener('click', () => {
            
            
            // (Bunu sayfa yenilenmeden hemen Ã¶nce yapmalÄ±yÄ±z)
            if (typeof socket !== 'undefined' && typeof currentUsername !== 'undefined') {
                socket.emit('leave-voice', { username: currentUsername });
            }

            // 2. Mikrofon ve BaÄŸlantÄ±larÄ± kes
            if (myStream) {
                myStream.getTracks().forEach(track => track.stop()); // Mikrofon Ä±ÅŸÄ±ÄŸÄ±nÄ± sÃ¶ndÃ¼rÃ¼r
            }
            if (peers) {
                Object.values(peers).forEach(call => call.close()); // BaÄŸlantÄ±larÄ± koparÄ±r
            }
            
            // 3. Kendi ekranÄ±ndaki 'IN VOICE' yazÄ±sÄ±nÄ± sil
            const myElem = document.querySelector(`[data-username="${currentUsername}"]`);
            if (myElem) {
                const badge = myElem.querySelector('.voice-badge');
                if (badge) badge.remove();
            }

            // 4. Butonu ESKÄ° HALÄ°NE getir
            const vBtn = document.getElementById('voiceBtn');
            if (vBtn) {
                vBtn.innerText = "JOIN VOICE";
                vBtn.style.color = "";       
                vBtn.style.borderColor = ""; 
                vBtn.style.boxShadow = "";   
                vBtn.disabled = false;       
                vBtn.style.cursor = "pointer";
            }

            // 5. Kontrol panelini gizle
            const actionsDiv = document.getElementById('voiceActions');
            if (actionsDiv) actionsDiv.style.display = 'none';
            
            // 6. SayfayÄ± yenile (Tertemiz bir baÅŸlangÄ±Ã§ iÃ§in)
            location.reload(); 
        });

        function addAudioStream(audio, stream) {
            audio.srcObject = stream;
            audio.addEventListener('loadedmetadata', () => {
                audio.play();
            });
            const container = document.getElementById('remote-audios');
            if(container) container.append(audio);
        }
    </script>
</body>
</html>